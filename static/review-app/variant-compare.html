<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Variant Comparison</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
:root{--bg:#0f1117;--surface:#1a1b23;--card:#21222d;--border:#2d2e3a;--accent:#7c6aef;--accent2:#22c55e;--danger:#ef4444;--warn:#f59e0b;--text:#e2e8f0;--dim:#94a3b8;--muted:#64748b;--radius:8px}
body{font-family:'Inter',-apple-system,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding:16px}
.vc-app{max-width:1400px;margin:0 auto}
.vc-header{display:flex;align-items:center;gap:16px;padding:16px 0;border-bottom:1px solid var(--border);margin-bottom:16px}
.vc-header h1{font-size:20px;font-weight:700;flex:1}
.card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:12px}
.card h2{font-size:14px;font-weight:600;margin-bottom:12px}
.grid-cards{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:12px}
.v-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px;transition:border-color .15s}
.v-card:hover{border-color:var(--accent)}
.v-card h3{font-size:14px;font-weight:700;margin-bottom:6px}
.v-card .strat{font-size:12px;color:var(--dim);line-height:1.5;margin-bottom:8px}
.v-card .audience{font-size:10px;color:var(--accent);margin-bottom:8px}
.stat-row{display:flex;gap:12px;flex-wrap:wrap}
.stat{font-size:11px}
.stat .label{color:var(--muted)}
.stat .val{font-weight:700;margin-left:4px}
.budget-bar{display:flex;height:8px;border-radius:4px;overflow:hidden;margin:4px 0}
.budget-bar div{height:100%;transition:width .3s}
.legend{display:flex;gap:8px;flex-wrap:wrap;font-size:10px;color:var(--dim);margin-top:4px}
.legend span{display:flex;align-items:center;gap:3px}
.legend span::before{content:'';width:8px;height:8px;border-radius:2px;display:inline-block}
.chart-container{position:relative;height:200px;display:flex;align-items:flex-end;gap:2px;padding:0 4px}
.chart-bar{flex:1;display:flex;flex-direction:column;align-items:center;gap:2px}
.chart-bar .bar{width:100%;border-radius:3px 3px 0 0;transition:height .3s;min-height:2px}
.chart-bar .bar-label{font-size:9px;color:var(--muted);writing-mode:vertical-rl;transform:rotate(180deg);max-height:60px;overflow:hidden}
.chart-bar .bar-val{font-size:9px;font-weight:600}
.winner-badge{display:inline-block;font-size:9px;padding:1px 6px;border-radius:8px;background:rgba(34,197,94,.15);color:var(--accent2);font-weight:600;margin-left:4px}
.tabs{display:flex;gap:2px;background:var(--surface);border-radius:var(--radius);padding:3px;margin-bottom:16px}
.tab{padding:8px 16px;border-radius:6px;border:none;background:transparent;color:var(--dim);font-size:12px;font-weight:600;cursor:pointer;transition:all .15s}
.tab:hover{color:var(--text)}.tab.active{background:var(--accent);color:#fff}
</style>
</head>
<body>
<div id="root"></div>
<script>
window.VARIANTS = __VARIANTS__;
window.PARENT_ID = "__PARENT_ID__";
window.THEME = "__THEME__";
</script>
<script type="text/babel">
const {useState} = React;

const COLORS = ['#7c6aef','#22c55e','#f59e0b','#ef4444','#06b6d4','#ec4899','#8b5cf6'];
const BUDGET_COLORS = ['#7c6aef','#22c55e','#f59e0b','#ef4444','#06b6d4','#ec4899','#8b5cf6','#a855f7'];

function StrategyCards({variants}) {
  return <div className="grid-cards">
    {variants.map((v, i) => {
      const budgetEntries = Object.entries(v.rtp_budget || {}).filter(([,val]) => typeof val === 'number');
      const total = budgetEntries.reduce((s,[,v]) => s+v, 0) || 100;
      return <div key={v.id} className="v-card" style={{borderLeftColor: COLORS[i], borderLeftWidth: 3}}>
        <h3>{v.icon} {v.label}</h3>
        <div className="strat">{v.strategy}</div>
        {v.target_audience && <div className="audience">üéØ {v.target_audience}</div>}
        <div className="stat-row">
          <div className="stat"><span className="label">RTP:</span><span className="val" style={{color:'var(--accent)'}}>{v.metrics?.rtp || '‚Äî'}%</span></div>
          <div className="stat"><span className="label">MaxWin:</span><span className="val" style={{color:'var(--warn)'}}>{v.metrics?.max_win || '‚Äî'}x</span></div>
          <div className="stat"><span className="label">Hit:</span><span className="val">{v.metrics?.hit_freq || '‚Äî'}%</span></div>
          <div className="stat"><span className="label">Vol:</span><span className="val">{v.metrics?.vol_idx || '‚Äî'}</span></div>
        </div>
        {budgetEntries.length > 0 && <>
          <div className="budget-bar" style={{marginTop:8}}>
            {budgetEntries.map(([k,pct], j) =>
              <div key={k} style={{width:`${(pct/total)*100}%`, background: BUDGET_COLORS[j%BUDGET_COLORS.length]}}/>
            )}
          </div>
          <div className="legend">
            {budgetEntries.map(([k,pct], j) =>
              <span key={k} style={{'--dot-color': BUDGET_COLORS[j%BUDGET_COLORS.length]}}>
                <span style={{background: BUDGET_COLORS[j%BUDGET_COLORS.length], width:8, height:8, borderRadius:2, display:'inline-block'}}/>
                {k.replace(/_/g,' ')} {pct}%
              </span>
            )}
          </div>
        </>}
        <div style={{marginTop:10, display:'flex', gap:6}}>
          {v.status === 'complete' && <a href={`/job/${v.id}/files`} style={{fontSize:11, color:'var(--accent)', textDecoration:'none'}}>üìÅ Files</a>}
          {v.status === 'complete' && <a href={`/review/${v.id}/interactive`} style={{fontSize:11, color:'var(--accent)', textDecoration:'none'}}>üìã Review</a>}
          {v.status !== 'complete' && <span style={{fontSize:11, color: v.status==='running'?'var(--warn)':'var(--danger)'}}>{v.status}</span>}
        </div>
      </div>;
    })}
  </div>;
}

function ComparisonChart({variants, metric, label, fmt}) {
  const vals = variants.map(v => {
    const raw = v.metrics?.[metric];
    return typeof raw === 'number' ? raw : parseFloat(raw) || 0;
  });
  const max = Math.max(...vals, 1);
  const best = Math.max(...vals);

  return <div style={{marginBottom:16}}>
    <div style={{fontSize:12, fontWeight:600, marginBottom:8}}>{label}</div>
    <div className="chart-container">
      {variants.map((v, i) => {
        const val = vals[i];
        const pct = max > 0 ? (val / max) * 100 : 0;
        const isBest = val === best && val > 0;
        return <div key={v.id} className="chart-bar">
          <div className="bar-val" style={{color: COLORS[i]}}>{val}{fmt}{isBest ? ' ‚òÖ' : ''}</div>
          <div className="bar" style={{height:`${Math.max(pct, 3)}%`, background: COLORS[i], opacity: val > 0 ? 1 : 0.3}}/>
          <div className="bar-label">{v.label}</div>
        </div>;
      })}
    </div>
  </div>;
}

function MetricTable({variants}) {
  const metrics = [
    ['RTP', 'rtp', '%', true],
    ['Max Win', 'max_win', 'x', true],
    ['Hit Frequency', 'hit_freq', '%', true],
    ['Volatility', 'vol_idx', '', null],
    ['Symbols', 'symbols', '', true],
    ['GDD Words', 'gdd_words', '', true],
    ['Compliance', 'compliance', '', null],
    ['Annual GGR', 'ggr_365d', '', true],
    ['ARPDAU', 'arpdau', '', true],
    ['1Y ROI', 'roi_365d', '%', true],
    ['Break-Even', 'break_even_days', ' days', false],
  ];

  return <table style={{width:'100%', borderCollapse:'collapse', fontSize:12}}>
    <thead>
      <tr>
        <th style={{textAlign:'left', padding:'6px 12px', color:'var(--muted)', fontSize:11}}>Metric</th>
        {variants.map((v,i) => <th key={v.id} style={{textAlign:'left', padding:'6px 12px'}}>
          <span style={{color: COLORS[i], fontWeight:700}}>{v.icon} {v.label}</span>
        </th>)}
      </tr>
    </thead>
    <tbody>
      {metrics.map(([label, key, fmt, higherBetter]) => {
        const vals = variants.map(v => v.metrics?.[key]);
        const numVals = vals.filter(v => typeof v === 'number');
        const best = higherBetter === true ? Math.max(...numVals) : higherBetter === false ? Math.min(...numVals) : null;
        return <tr key={key} style={{borderBottom:'1px solid var(--border)'}}>
          <td style={{padding:'6px 12px', color:'var(--muted)'}}>{label}</td>
          {vals.map((val, i) => {
            const isBest = best !== null && val === best && numVals.length > 1;
            return <td key={i} style={{padding:'6px 12px', fontFamily:'monospace', fontWeight: isBest ? 700 : 400}}>
              {val ?? '‚Äî'}{typeof val === 'number' ? fmt : ''}
              {isBest && <span className="winner-badge">best</span>}
            </td>;
          })}
        </tr>;
      })}
    </tbody>
  </table>;
}

function VariantCompareApp() {
  const variants = window.VARIANTS || [];
  const [tab, setTab] = useState('cards');

  return <div className="vc-app">
    <div className="vc-header">
      <a href="/history" style={{color:'var(--dim)', fontSize:12, textDecoration:'none'}}>‚Üê History</a>
      <h1>üîÄ {window.THEME} ‚Äî Variant Comparison</h1>
      <span style={{fontSize:12, color:'var(--dim)'}}>{variants.length} variants</span>
    </div>

    <div className="tabs">
      {[['cards','üìä Strategies'],['table','üìã Table'],['charts','üìà Charts']].map(([id,label]) =>
        <button key={id} className={`tab ${tab===id?'active':''}`} onClick={() => setTab(id)}>{label}</button>
      )}
    </div>

    {tab === 'cards' && <StrategyCards variants={variants}/>}

    {tab === 'table' && <div className="card" style={{overflowX:'auto'}}>
      <h2>Side-by-Side Comparison</h2>
      <MetricTable variants={variants}/>
    </div>}

    {tab === 'charts' && <div className="card">
      <h2>Visual Comparison</h2>
      <div style={{display:'grid', gridTemplateColumns:'1fr 1fr', gap:16}}>
        <ComparisonChart variants={variants} metric="rtp" label="RTP %" fmt="%"/>
        <ComparisonChart variants={variants} metric="max_win" label="Max Win" fmt="x"/>
        <ComparisonChart variants={variants} metric="hit_freq" label="Hit Frequency %" fmt="%"/>
        <ComparisonChart variants={variants} metric="gdd_words" label="GDD Word Count" fmt=""/>
      </div>
    </div>}
  </div>;
}

ReactDOM.createRoot(document.getElementById('root')).render(<VariantCompareApp/>);
</script>
</body>
</html>
